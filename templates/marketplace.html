<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INK | Marketplace</title>
    
    <!-- Import Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Base Styles */
        :root {
            --ink-black: #000000;
            --ink-white: #ffffff;
            --ink-gray-light: #f0f0f0;
            --ink-gray-dark: #333333;
            --ink-purple: #7b3eab;
            --ink-blue: #3f51b5;
            --ink-green: #4caf50;
            --ink-amber: #ffc107;
            --ink-orange: #ff5722;
            --ink-red: #f44336;
            --ink-teal: #009688;
            --pixel-size: 8px;
            --menu-width: 250px;
            --menu-collapsed-width: 60px;
            --menu-transition: 0.3s ease;
            --header-height: 80px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background-color: var(--ink-black);
            color: var(--ink-white);
            overflow-x: hidden;
            min-height: 100vh;
            image-rendering: pixelated;
            font-size: 0.7rem;
            line-height: 1.5;
        }

        /* Header Styles */
        .header {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            height: var(--header-height);
            border-bottom: 2px solid var(--ink-white);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--ink-black);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .header.hide {
            transform: translateY(-100%);
        }

        .ink-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 2rem;
            letter-spacing: 4px;
            margin-left: 80px;
        }

        .user-info {
            margin-left: auto;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dashboard-btn {
            padding: 0.5rem 1rem;
            background: var(--ink-white);
            color: var(--ink-black);
            text-decoration: none;
            font-size: 0.7rem;
            border-radius: 0;
            cursor: pointer;
            border: none;
            font-family: 'Press Start 2P', monospace;
            /* Pixel-like effect */
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }

        /* Pixel Heart */
        .pixel-heart {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 2px;
            z-index: 10;
        }

        .heart-pixel {
            width: 100%;
            height: 100%;
            background: var(--ink-white);
            animation: pixel-pulse 2s infinite;
        }

        @keyframes pixel-pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* Hero Section */
        .hero-container {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            margin-top: var(--header-height);
            transition: transform 0.5s ease-out;
        }
        
        .hero-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.5;
            filter: blur(5px);
            z-index: -1;
        }
        
        .hero-title {
            font-size: 4rem;
            text-align: center;
            letter-spacing: 8px;
            margin-bottom: 2rem;
            text-shadow: 4px 4px 0px var(--ink-purple), 8px 8px 0px rgba(0,0,0,0.5);
            animation: title-float 3s ease-in-out infinite;
        }
        
        @keyframes title-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .hero-buttons {
            display: flex;
            gap: 2rem;
        }
        
        .hero-btn {
            padding: 1rem 2rem;
            font-family: 'Press Start 2P', monospace;
            font-size: 1rem;
            background-color: var(--ink-purple);
            color: var(--ink-white);
            border: none;
            cursor: pointer;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
            transition: transform 0.2s, background-color 0.2s;
        }
        
        .hero-btn:hover {
            transform: translateY(-5px);
            background-color: #9c4dcc;
        }
        
        /* Fixed Header on Scroll */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--ink-black);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            z-index: 100;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            border-bottom: 2px solid var(--ink-white);
        }
        
        .fixed-header.show {
            transform: translateY(0);
        }
        
        .fixed-header-title {
            font-size: 1.2rem;
            letter-spacing: 2px;
        }
        
        .search-container {
            margin-left: auto;
            margin-right: 1rem;
            display: flex;
            align-items: center;
        }
        
        .search-input {
            padding: 0.5rem;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            background-color: var(--ink-white);
            color: var(--ink-black);
            border: none;
            width: 200px;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        /* Category Navigation */
        .category-nav {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.5);
            margin-top: 1rem;
            scrollbar-width: none;  /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        
        .category-nav::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera */
        }
        
        .category-item {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .category-item:hover {
            transform: translateY(-5px);
        }
        
        .category-icon {
            width: 48px;
            height: 48px;
            background-color: var(--ink-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .category-icon i {
            font-size: 1.5rem;
        }
        
        .category-label {
            font-size: 0.6rem;
            text-align: center;
        }
        
        /* Main Content Styles */
        .main-container {
            padding: 2rem;
            margin-top: 50px;
        }
        
        .section-title {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-shadow: 3px 3px 0 rgba(123, 62, 171, 0.5);
        }
        
        /* Filter Bar */
        .filter-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .filter-label {
            font-size: 0.7rem;
        }
        
        .filter-select {
            padding: 0.5rem;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.6rem;
            background-color: var(--ink-white);
            color: var(--ink-black);
            border: none;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .create-btn {
            padding: 0.5rem 1rem;
            background-color: var(--ink-purple);
            color: var(--ink-white);
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .create-btn:hover {
            background-color: #9c4dcc;
        }

        /* Listings Grid */
        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }
        
        .listing-card {
            background-color: var(--ink-white);
            color: var(--ink-black);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .listing-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(123, 62, 171, 0.3);
        }
        
        .listing-preview {
            height: 180px;
            overflow: hidden;
            position: relative;
        }
        
        .listing-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
            image-rendering: auto;
        }
        
        .listing-card:hover .listing-preview img {
            transform: scale(1.1);
        }
        
        .listing-type {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 0.3rem 0.5rem;
            font-size: 0.6rem;
            background-color: var(--ink-purple);
            color: var(--ink-white);
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        .listing-details {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .listing-course {
            font-size: 0.6rem;
            color: var(--ink-purple);
        }
        
        .listing-title {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .listing-description {
            font-family: 'Poppins', sans-serif;
            font-size: 0.7rem;
            color: var(--ink-gray-dark);
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-top: 0.5rem;
        }
        
        .listing-footer {
            padding: 0.8rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--ink-gray-light);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .listing-price {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: var(--ink-purple);
        }
        
        .listing-price img {
            width: 16px;
            height: 16px;
        }
        
        .listing-stats {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        .listing-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.6rem;
            color: var(--ink-gray-dark);
        }
        
        .listing-seller {
            margin-top: 0.5rem;
            font-size: 0.6rem;
            color: var(--ink-gray-dark);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .seller-avatar {
            width: 20px;
            height: 20px;
            border-radius: 0;
            background-color: var(--ink-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ink-white);
            font-size: 0.5rem;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 3rem;
            gap: 0.5rem;
        }
        
        .page-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--ink-white);
            color: var(--ink-black);
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
            transition: transform 0.2s, background-color 0.2s;
        }
        
        .page-btn:hover:not(.active):not(.disabled) {
            transform: translateY(-3px);
            background-color: var(--ink-gray-light);
        }
        
        .page-btn.active {
            background-color: var(--ink-purple);
            color: var(--ink-white);
            pointer-events: none;
        }
        
        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background-color: var(--ink-white);
            color: var(--ink-black);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            transform: translateY(50px);
            transition: transform 0.3s;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .modal-overlay.show .modal-container {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 2px solid var(--ink-black);
        }
        
        .modal-title {
            font-size: 1.2rem;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--ink-black);
        }
        
        .modal-content {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            padding: 0;
        }
        
        .modal-left, .modal-center, .modal-right {
            padding: 1.5rem;
        }
        
        .modal-left {
            flex: 1;
            min-width: 250px;
        }
        
        .modal-center {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            min-width: 300px;
        }
        
        .modal-right {
            flex: 1;
            min-width: 250px;
            background-color: var(--ink-gray-light);
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 2px solid var(--ink-black);
        }
        
        /* Product Detail Styles */
        .product-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .product-course {
            font-size: 0.8rem;
            color: var(--ink-purple);
            margin-bottom: 1rem;
        }
        
        .product-quality {
            display: inline-block;
            padding: 0.3rem 0.5rem;
            font-size: 0.7rem;
            background-color: var(--ink-amber);
            color: var(--ink-black);
            margin-bottom: 1.5rem;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        .attribute-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .attribute-card {
            padding: 1rem;
            background-color: var(--ink-white);
            border: 2px solid var(--ink-gray-dark);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        .attribute-label {
            font-size: 0.6rem;
            color: var(--ink-gray-dark);
        }
        
        .attribute-value {
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .product-description {
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            line-height: 1.6;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--ink-purple);
        }
        
        /* Floating Preview Card */
        .preview-card {
            width: 100%;
            max-width: 350px;
            height: 450px;
            position: relative;
            perspective: 1500px;
            margin: 0 auto;
        }
        
        .preview-card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotateY(5deg);
            }
            50% {
                transform: translateY(-15px) rotateY(-5deg);
            }
        }
        
        .preview-card-front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background-color: var(--ink-white);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(123, 62, 171, 0.5);
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .preview-image {
            width: 100%;
            height: 60%;
            object-fit: cover;
            border-bottom: 2px solid var(--ink-black);
        }
        
        .preview-content {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .preview-type {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 0.3rem 0.5rem;
            font-size: 0.6rem;
            background-color: var(--ink-purple);
            color: var(--ink-white);
            z-index: 1;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        .preview-department {
            position: absolute;
            bottom: 45%;
            right: 10px;
            padding: 0.3rem 0.5rem;
            font-size: 0.6rem;
            background-color: var(--ink-black);
            color: var(--ink-white);
            z-index: 1;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        .preview-quality {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--ink-amber);
            color: var(--ink-black);
            font-weight: bold;
            z-index: 1;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        /* Purchase Panel */
        .price-display {
            font-size: 2rem;
            color: var(--ink-purple);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .price-display img {
            width: 24px;
            height: 24px;
        }
        
        .seller-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background-color: var(--ink-white);
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .seller-avatar-large {
            width: 50px;
            height: 50px;
            background-color: var(--ink-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ink-white);
            font-size: 1rem;
            clip-path: polygon(
                0 0, 
                calc(100% - 5px) 0, 
                100% 5px, 
                100% 100%, 
                5px 100%, 
                0 calc(100% - 5px)
            );
        }
        
        .seller-details {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .seller-name {
            font-size: 0.8rem;
        }
        
        .seller-rating {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.7rem;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .purchase-btn, .preview-btn, .favorite-btn {
            padding: 1rem;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
            transition: transform 0.2s, background-color 0.2s;
        }
        
        .purchase-btn {
            background-color: var(--ink-purple);
            color: var(--ink-white);
        }
        
        .purchase-btn:hover {
            background-color: #9c4dcc;
            transform: translateY(-3px);
        }
        
        .preview-btn {
            background-color: var(--ink-white);
            color: var(--ink-black);
            border: 2px solid var(--ink-black);
        }
        
        .preview-btn:hover {
            background-color: var(--ink-gray-light);
            transform: translateY(-3px);
        }
        
        .favorite-btn {
            background-color: var(--ink-white);
            color: var(--ink-red);
            border: 2px solid var(--ink-red);
        }
        
        .favorite-btn:hover {
            background-color: rgba(244, 67, 54, 0.1);
            transform: translateY(-3px);
        }
        
        /* Statistics Section */
        .stats-container {
            background-color: var(--ink-black);
            color: var(--ink-white);
            padding: 1.5rem;
            margin-top: 1.5rem;
            clip-path: polygon(
                0 calc(15px), 
                15px 0, 
                calc(100% - 15px) 0, 
                100% 15px, 
                100% 100%, 
                0 100%
            );
        }
        
        .stats-title {
            font-size: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--ink-gray-dark);
            padding-bottom: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            color: var(--ink-purple);
        }
        
        .stat-label {
            font-size: 0.6rem;
            color: var(--ink-gray-light);
        }
        
        .popularity-indicator {
            font-size: 0.7rem;
            text-align: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Reviews Section */
        .tabs-container {
            margin-top: 2rem;
        }
        
        .tabs-header {
            display: flex;
            border-bottom: 2px solid var(--ink-gray-dark);
        }
        
        .tab-btn {
            padding: 0.8rem 1.5rem;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            background: none;
            border: none;
            color: var(--ink-white);
            cursor: pointer;
            position: relative;
        }
        
        .tab-btn.active {
            color: var(--ink-purple);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--ink-purple);
        }
        
        .tab-content {
            padding: 1.5rem 0;
        }
        
        .reviews-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .review-card {
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.05);
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }
        
        .reviewer-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .reviewer-avatar {
            width: 30px;
            height: 30px;
            background-color: var(--ink-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ink-white);
            font-size: 0.7rem;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }
        
        .reviewer-name {
            font-size: 0.7rem;
        }
        
        .review-rating {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--ink-amber);
            font-size: 0.7rem;
        }
        
        .review-date {
            font-size: 0.6rem;
            color: var(--ink-gray-dark);
        }
        
        .review-content {
            font-family: 'Poppins', sans-serif;
            font-size: 0.8rem;
            line-height: 1.5;
        }
        
        /* Related Items */
        .related-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .related-card {
            background-color: rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }
        
        .related-card:hover {
            transform: translateY(-5px);
        }
        
        .related-preview {
            height: 120px;
            overflow: hidden;
        }
        
        .related-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .related-details {
            padding: 0.8rem;
        }
        
        .related-title {
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
        }
        
        .related-price {
            font-size: 0.6rem;
            color: var(--ink-purple);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        /* Create Listing Modal Styles */
        .form-row {
            margin-bottom: 1.2rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            font-size: 0.7rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid var(--ink-gray-dark);
            font-family: 'Press Start 2P', monospace;
            font-size: 0.65rem;
            resize: vertical;
            background-color: var(--ink-white);
            color: var(--ink-black);
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--ink-purple);
        }

        .form-help {
            margin-top: 0.3rem;
            font-size: 0.55rem;
            color: var(--ink-gray-light);
        }

        .upload-container {
            padding: 2rem;
            border: 2px dashed var(--ink-gray-light);
            text-align: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .upload-container:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--ink-gray-light);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 0.7rem;
            color: var(--ink-gray-light);
        }

        .upload-subtitle {
            font-size: 0.6rem;
            color: var(--ink-gray-dark);
            margin-top: 0.5rem;
        }

        .price-slider {
            width: 100%;
            margin: 1rem 0;
        }

        .price-display-small {
            font-size: 1.2rem;
            color: var(--ink-purple);
            text-align: center;
            margin-bottom: 1rem;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag-item {
            padding: 0.3rem 0.5rem;
            background-color: var(--ink-purple);
            color: var(--ink-white);
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            clip-path: polygon(
                0 0, 
                calc(100% - 3px) 0, 
                100% 3px, 
                100% 100%, 
                3px 100%, 
                0 calc(100% - 3px)
            );
        }

        .tag-remove {
            cursor: pointer;
            color: var(--ink-white);
            font-size: 0.8rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .cancel-btn, .submit-btn {
            padding: 0.8rem 1.5rem;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7rem;
            border: none;
            cursor: pointer;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }

        .cancel-btn {
            background-color: var(--ink-gray-dark);
            color: var(--ink-white);
        }

        .submit-btn {
            background-color: var(--ink-purple);
            color: var(--ink-white);
        }

        /* Pixel Coin */
        .pixel-coin {
            width: 16px;
            height: 16px;
            background-color: var(--ink-amber);
            border-radius: 0;
            position: relative;
            display: inline-block;
            clip-path: polygon(
                25% 0%, 75% 0%, 100% 25%, 100% 75%, 75% 100%, 25% 100%, 0% 75%, 0% 25%
            );
        }

        .pixel-coin::before {
            content: '';
            position: absolute;
            top: 25%;
            left: 25%;
            width: 50%;
            height: 50%;
            background-color: var(--ink-white);
            clip-path: polygon(
                25% 0%, 75% 0%, 100% 25%, 100% 75%, 75% 100%, 25% 100%, 0% 75%, 0% 25%
            );
        }

        .large-coin {
            width: 24px;
            height: 24px;
        }

        /* Loading indicator */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loading-pixels {
            display: flex;
            gap: 8px;
        }

        .loading-pixel {
            width: 16px;
            height: 16px;
            background-color: var(--ink-purple);
            animation: loading-animation 1.2s infinite ease-in-out;
        }

        .loading-pixel:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-pixel:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes loading-animation {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.5); opacity: 0.5; }
        }

        /* Feedback Message */
        .feedback-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            font-size: 0.8rem;
            color: var(--ink-white);
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s;
            clip-path: polygon(
                0 0, 
                calc(100% - var(--pixel-size)) 0, 
                100% var(--pixel-size), 
                100% 100%, 
                var(--pixel-size) 100%, 
                0 calc(100% - var(--pixel-size))
            );
        }

        .feedback-message.show {
            transform: translateX(0);
        }

        .feedback-message.success {
            background-color: var(--ink-green);
        }

        .feedback-message.error {
            background-color: var(--ink-red);
        }

        .feedback-message.warning {
            background-color: var(--ink-amber);
            color: var(--ink-black);
        }

        /* Media Queries */
        @media (max-width: 1200px) {
            .hero-title {
                font-size: 3rem;
            }
            
            .modal-content {
                flex-direction: column;
            }
            
            .modal-left, .modal-center, .modal-right {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }
            
            .listings-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .attribute-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tab-btn {
                padding: 0.8rem 1rem;
                font-size: 0.6rem;
            }
        }

        @media (max-width: 576px) {
            .header {
                padding: 1rem;
            }
            
            .ink-title {
                font-size: 1.5rem;
                margin-left: 50px;
            }
            
            .pixel-heart {
                width: 30px;
                height: 30px;
            }
            
            .hero-buttons {
                flex-direction: column;
                gap: 1rem;
            }
            
            .hero-btn {
                width: 100%;
            }
            
            .listings-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
                gap: 1rem;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .create-btn {
                width: 100%;
            }
            
            .tabs-header {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" id="header">
        <div class="pixel-heart" id="pixelHeart"></div>
        <h1 class="ink-title">INK</h1>
        <div class="user-info">
            <span id="username">{{ user.username }}</span>
            <a href="/dashboard" class="dashboard-btn">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
        </div>
    </header>
    
    <!-- Fixed Header (appears on scroll) -->
    <div class="fixed-header" id="fixedHeader">
        <h2 class="fixed-header-title">Marketplace</h2>
        <div class="search-container">
            <input type="text" class="search-input" id="fixedSearchInput" placeholder="Search marketplace...">
        </div>
        <div class="user-info">
            <span id="fixedUsername">{{ user.username }}</span>
            <a href="/dashboard" class="dashboard-btn">
                <i class="fas fa-th-large"></i>
            </a>
        </div>
    </div>
    
    <!-- Hero Section -->
    <div class="hero-container" id="heroContainer">
        <img src="static/assets/marketplace.gif" alt="Marketplace background" class="hero-bg">
        <h1 class="hero-title">MARKETPLACE</h1>
        <div class="hero-buttons">
            <button class="hero-btn" id="exploreBtn">
                <i class="fas fa-search"></i> Explore
            </button>
            <button class="hero-btn" id="createListingBtn">
                <i class="fas fa-plus"></i> Create Listing
            </button>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Category Navigation -->
        <div class="category-nav">
            <div class="category-item" data-category="all">
                <div class="category-icon">
                    <i class="fas fa-th"></i>
                </div>
                <div class="category-label">All</div>
            </div>
            <div class="category-item" data-category="Computer Science">
                <div class="category-icon">
                    <i class="fas fa-laptop-code"></i>
                </div>
                <div class="category-label">Computer Science</div>
            </div>
            <div class="category-item" data-category="Business">
                <div class="category-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="category-label">Business</div>
            </div>
            <div class="category-item" data-category="Law">
                <div class="category-icon">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="category-label">Law</div>
            </div>
            <div class="category-item" data-category="Engineering">
                <div class="category-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="category-label">Engineering</div>
            </div>
            <div class="category-item" data-category="Science">
                <div class="category-icon">
                    <i class="fas fa-atom"></i>
                </div>
                <div class="category-label">Science</div>
            </div>
            <div class="category-item" data-category="Arts">
                <div class="category-icon">
                    <i class="fas fa-paint-brush"></i>
                </div>
                <div class="category-label">Arts</div>
            </div>
            <div class="category-item" data-category="Data Science">
                <div class="category-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="category-label">Data Science</div>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <span class="filter-label">Sort By:</span>
                <select class="filter-select" id="sortSelect">
                    <option value="newest">Newest First</option>
                    <option value="price_low">Price: Low to High</option>
                    <option value="price_high">Price: High to Low</option>
                    <option value="popular">Most Popular</option>
                    <option value="relevant">Relevant to You</option>
                </select>
            </div>
            
            <div class="filter-group">
                <span class="filter-label">Type:</span>
                <select class="filter-select" id="typeSelect">
                    <option value="all">All Types</option>
                    <option value="notes">Notes</option>
                    <option value="template">Templates</option>
                    <option value="study guide">Study Guides</option>
                    <option value="practice tests">Practice Tests</option>
                    <option value="service">Services</option>
                    <option value="research paper">Research Papers</option>
                </select>
            </div>
            
            <div class="filter-group">
                <input type="text" class="search-input" id="searchInput" placeholder="Search marketplace...">
            </div>
            
            <button class="create-btn" id="createBtn">
                <i class="fas fa-plus"></i> Create Listing
            </button>
        </div>
        
        <!-- Listings Section -->
        <h2 class="section-title">Browse Listings</h2>
        
        <div class="listings-grid" id="listingsGrid">
            <!-- Listings will be populated via JavaScript -->
            <div class="loading-container">
                <div class="loading-pixels">
                    <div class="loading-pixel"></div>
                    <div class="loading-pixel"></div>
                    <div class="loading-pixel"></div>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" id="pagination">
            <!-- Pagination will be populated via JavaScript -->
        </div>
    </div>
    
    <!-- Product Detail Modal -->
    <div class="modal-overlay" id="productDetailModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Listing Details</h2>
                <button class="modal-close" id="closeDetailModal">&times;</button>
            </div>
            
            <div class="modal-content">
                <div class="modal-left">
                    <h3 class="product-title" id="productTitle">Product Title</h3>
                    <div class="product-course" id="productCourse">CSC301</div>
                    <div class="product-quality" id="productQuality">Comprehensive</div>
                    
                    <div class="attribute-grid">
                        <div class="attribute-card">
                            <div class="attribute-label">Department</div>
                            <div class="attribute-value" id="productDepartment">
                                <i class="fas fa-building"></i> Computer Science
                            </div>
                        </div>
                        <div class="attribute-card">
                            <div class="attribute-label">Updated</div>
                            <div class="attribute-value" id="productUpdated">
                                <i class="fas fa-calendar"></i> May 2023
                            </div>
                        </div>
                        <div class="attribute-card">
                            <div class="attribute-label">Pages/Length</div>
                            <div class="attribute-value" id="productPages">
                                <i class="fas fa-file-alt"></i> 145 pages
                            </div>
                        </div>
                        <div class="attribute-card">
                            <div class="attribute-label">Format</div>
                            <div class="attribute-value" id="productFormat">
                                <i class="fas fa-file-pdf"></i> PDF
                            </div>
                        </div>
                    </div>
                    
                    <div class="product-description" id="productDescription">
                        Loading description...
                    </div>
                </div>
                
                <div class="modal-center">
                    <div class="preview-card">
                        <div class="preview-card-inner">
                            <div class="preview-card-front">
                                <div class="preview-type" id="previewType">Notes</div>
                                <div class="preview-quality" id="previewQuality">A+</div>
                                <div class="preview-department" id="previewDepartment">CS</div>
                                <img id="previewImage" src="" alt="Preview" class="preview-image">
                                <div class="preview-content">
                                    <div id="previewTitle" class="preview-title">Loading...</div>
                                    <div id="previewCourse" class="preview-course">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-right">
                    <div class="price-display">
                        <div class="pixel-coin large-coin"></div>
                        <span id="productPrice">250</span>
                    </div>
                    
                    <div class="seller-info">
                        <div class="seller-avatar-large" id="sellerAvatar">JS</div>
                        <div class="seller-details">
                            <div class="seller-name" id="sellerName">John Smith</div>
                            <div class="seller-rating">
                                <i class="fas fa-star" style="color: var(--ink-amber);"></i>
                                <span id="sellerRating">4.9</span>
                                <span>(<span id="reviewCount">24</span> reviews)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="purchase-btn" id="purchaseBtn">
                            <i class="fas fa-shopping-cart"></i> Purchase
                        </button>
                        <button class="preview-btn" id="previewBtn">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="favorite-btn" id="favoriteBtn">
                            <i class="far fa-heart"></i> Add to Favorites
                        </button>
                    </div>
                    
                    <div class="stats-container">
                        <h4 class="stats-title">Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="downloadCount">45</div>
                                <div class="stat-label">Downloads</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="viewCount">128</div>
                                <div class="stat-label">Views</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="wishlistCount">12</div>
                                <div class="stat-label">Wishlisted</div>
                            </div>
                        </div>
                        
                        <div class="popularity-indicator" id="popularityText">
                            15 students from your department purchased this item
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button class="tab-btn active" data-tab="reviews">Reviews</button>
                        <button class="tab-btn" data-tab="related">Related Items</button>
                    </div>
                    
                    <div class="tab-content" id="reviewsTab">
                        <div class="reviews-container" id="reviewsContainer">
                            <!-- Reviews will be populated via JavaScript -->
                            <div class="loading-container">
                                <div class="loading-pixels">
                                    <div class="loading-pixel"></div>
                                    <div class="loading-pixel"></div>
                                    <div class="loading-pixel"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="relatedTab" style="display: none;">
                        <div class="related-items" id="relatedItems">
                            <!-- Related items will be populated via JavaScript -->
                            <div class="loading-container">
                                <div class="loading-pixels">
                                    <div class="loading-pixel"></div>
                                    <div class="loading-pixel"></div>
                                    <div class="loading-pixel"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Listing Modal -->
    <div class="modal-overlay" id="createListingModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Create Listing</h2>
                <button class="modal-close" id="closeCreateModal">&times;</button>
            </div>
            
            <form id="createListingForm">
                <div class="modal-content">
                    <div class="modal-left">
                        <div class="form-row">
                            <label class="form-label" for="listingTitle">Title</label>
                            <input type="text" id="listingTitle" class="form-input" placeholder="Enter a descriptive title" required>
                            <div class="form-help">Be clear and specific about what you're offering.</div>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label" for="listingDescription">Description</label>
                            <textarea id="listingDescription" class="form-textarea" placeholder="Describe your listing in detail" rows="6" required></textarea>
                            <div class="form-help">Include key details, features, and why it's valuable.</div>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label" for="listingSubject">Course/Subject</label>
                            <input type="text" id="listingSubject" class="form-input" placeholder="e.g., CSC301, BUS405" required>
                            <div class="form-help">Specify the course code this material is for.</div>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label" for="listingCategory">Category</label>
                            <select id="listingCategory" class="form-select" required>
                                <option value="">Select a Category</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Business">Business</option>
                                <option value="Data Science">Data Science</option>
                                <option value="Law">Law</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Arts">Arts</option>
                                <option value="Science">Science</option>
                                <option value="Medicine">Medicine</option>
                                <option value="Economics">Economics</option>
                                <option value="Mathematics">Mathematics</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label" for="listingType">Material Type</label>
                            <select id="listingType" class="form-select" required>
                                <option value="">Select a Type</option>
                                <option value="notes">Notes</option>
                                <option value="template">Template</option>
                                <option value="study guide">Study Guide</option>
                                <option value="practice tests">Practice Tests</option>
                                <option value="service">Service</option>
                                <option value="research paper">Research Paper</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Tags (up to 5)</label>
                            <input type="text" id="tagInput" class="form-input" placeholder="Enter a tag and press Enter">
                            <div class="tags-container" id="tagsContainer"></div>
                            <div class="form-help">Add relevant keywords to help others find your listing.</div>
                        </div>
                    </div>
                    
                    <div class="modal-right">
                        <div class="form-row">
                            <label class="form-label">Upload Content</label>
                            <div class="upload-container" id="fileUploadContainer">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="upload-text">Drag & drop your file here</div>
                                <div class="upload-subtitle">or click to browse</div>
                                <input type="file" id="fileUpload" style="display: none;">
                            </div>
                            <div class="form-help">Upload the material you want to sell (PDF, DOCX, PPTX, etc.).</div>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Preview Image</label>
                            <div class="upload-container" id="imageUploadContainer">
                                <div class="upload-icon">
                                    <i class="fas fa-image"></i>
                                </div>
                                <div class="upload-text">Add a thumbnail image</div>
                                <div class="upload-subtitle">PNG, JPG, or GIF (recommended)</div>
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            </div>
                            <div id="imagePreviewContainer" style="display: none; margin-top: 1rem;">
                                <img id="imagePreview" style="max-width: 100%; max-height: 200px; object-fit: contain;">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <label class="form-label">Price (in coins)</label>
                            <input type="range" id="priceSlider" class="price-slider" min="20" max="500" step="5" value="50">
                            <div class="price-display-small">
                                <div class="pixel-coin"></div> <span id="priceDisplay">50</span>
                            </div>
                            <div class="form-help">Set a fair price based on the quality and extent of your material.</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <div class="modal-actions">
                        <button type="button" class="cancel-btn" id="cancelCreateBtn">Cancel</button>
                        <button type="submit" class="submit-btn">Create Listing</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Feedback Message -->
    <div class="feedback-message" id="feedbackMessage"></div>
    
    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            // DOM Elements - using conditional chaining to avoid null references
            const header = document.getElementById('header');
            const fixedHeader = document.getElementById('fixedHeader');
            const heroContainer = document.getElementById('heroContainer');
            const pixelHeart = document.getElementById('pixelHeart');
            const listingsGrid = document.getElementById('listingsGrid');
            const pagination = document.getElementById('pagination');
            const productDetailModal = document.getElementById('productDetailModal');
            const closeDetailModal = document.getElementById('closeDetailModal');
            const createListingModal = document.getElementById('createListingModal');
            const closeCreateModal = document.getElementById('closeCreateModal');
            const cancelCreateBtn = document.getElementById('cancelCreateBtn');
            const createBtn = document.getElementById('createBtn');
            const createListingBtn = document.getElementById('createListingBtn');
            const exploreBtn = document.getElementById('exploreBtn');
            const searchInput = document.getElementById('searchInput');
            const fixedSearchInput = document.getElementById('fixedSearchInput');
            const sortSelect = document.getElementById('sortSelect');
            const typeSelect = document.getElementById('typeSelect');
            const categoryItems = document.querySelectorAll('.category-item');
            const tabBtns = document.querySelectorAll('.tab-btn');
            const reviewsTab = document.getElementById('reviewsTab');
            const relatedTab = document.getElementById('relatedTab');
            const feedbackMessage = document.getElementById('feedbackMessage');

            // Form Elements
            const createListingForm = document.getElementById('createListingForm');
            const listingTitle = document.getElementById('listingTitle');
            const listingDescription = document.getElementById('listingDescription');
            const listingSubject = document.getElementById('listingSubject');
            const listingCategory = document.getElementById('listingCategory');
            const listingType = document.getElementById('listingType');
            const tagInput = document.getElementById('tagInput');
            const tagsContainer = document.getElementById('tagsContainer');
            const fileUploadContainer = document.getElementById('fileUploadContainer');
            const fileUpload = document.getElementById('fileUpload');
            const imageUploadContainer = document.getElementById('imageUploadContainer');
            const imageUpload = document.getElementById('imageUpload');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreviewElem = document.getElementById('imagePreview'); // Changed variable name to avoid conflict

            // Price elements
            const priceSlider = document.getElementById('priceSlider');
            const priceDisplay = document.getElementById('priceDisplay');

            // Product Detail Elements
            const productTitle = document.getElementById('productTitle');
            const productCourse = document.getElementById('productCourse');
            const productQuality = document.getElementById('productQuality');
            const productDepartment = document.getElementById('productDepartment');
            const productUpdated = document.getElementById('productUpdated');
            const productPages = document.getElementById('productPages');
            const productFormat = document.getElementById('productFormat');
            const productDescription = document.getElementById('productDescription');
            const previewType = document.getElementById('previewType');
            const previewQuality = document.getElementById('previewQuality');
            const previewDepartment = document.getElementById('previewDepartment');
            const previewImageElem = document.getElementById('previewImage'); // Changed variable name to avoid conflict
            const previewTitle = document.getElementById('previewTitle');
            const previewCourse = document.getElementById('previewCourse');
            const productPrice = document.getElementById('productPrice');
            const sellerAvatar = document.getElementById('sellerAvatar');
            const sellerName = document.getElementById('sellerName');
            const sellerRating = document.getElementById('sellerRating');
            const reviewCount = document.getElementById('reviewCount');
            const downloadCount = document.getElementById('downloadCount');
            const viewCount = document.getElementById('viewCount');
            const wishlistCount = document.getElementById('wishlistCount');
            const popularityText = document.getElementById('popularityText');
            const purchaseBtn = document.getElementById('purchaseBtn');
            const previewBtn = document.getElementById('previewBtn');
            const favoriteBtn = document.getElementById('favoriteBtn');
            const reviewsContainer = document.getElementById('reviewsContainer');
            const relatedItems = document.getElementById('relatedItems');
            
            // Create Pixel Heart
            const createPixelHeart = () => {
                const heartPattern = [
                    [0, 1, 0, 1, 0],
                    [1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1],
                    [0, 1, 1, 1, 0],
                    [0, 0, 1, 0, 0]
                ];
                
                heartPattern.forEach((row, rowIndex) => {
                    row.forEach((cell, colIndex) => {
                        if (cell) {
                            const pixel = document.createElement('div');
                            pixel.className = 'heart-pixel';
                            pixel.style.gridRow = rowIndex + 1;
                            pixel.style.gridColumn = colIndex + 1;
                            pixelHeart.appendChild(pixel);
                        }
                    });
                });
            };
            
            // Initialize pixel heart
            createPixelHeart();
            
            // Scroll handling for fixed header
            window.addEventListener('scroll', () => {
                const scrollPosition = window.scrollY;
                const heroHeight = heroContainer.offsetHeight;
                
                if (scrollPosition > heroHeight) {
                    fixedHeader.classList.add('show');
                    header.classList.add('hide');
                } else {
                    fixedHeader.classList.remove('show');
                    header.classList.remove('hide');
                }
            });
            
            // Explore button scrolls to listings
            exploreBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: heroContainer.offsetHeight,
                    behavior: 'smooth'
                });
            });
            
            // Search functionality
            const handleSearch = (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                // If this is the fixed search input, update the main search input
                if (e.target === fixedSearchInput) {
                    searchInput.value = searchTerm;
                } else {
                    fixedSearchInput.value = searchTerm;
                }
                
                loadListings();
            };
            
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    handleSearch(e);
                }
            });
            
            fixedSearchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    handleSearch(e);
                }
            });
            
            // Sort functionality
            sortSelect.addEventListener('change', () => {
                loadListings();
            });
            
            // Type filter functionality
            typeSelect.addEventListener('change', () => {
                loadListings();
            });
            
            // Category filter functionality
            categoryItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Remove active class from all items
                    categoryItems.forEach(i => i.classList.remove('active'));
                    
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    // Load listings with the selected category
                    loadListings();
                });
            });
            
            // Tab functionality
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabBtns.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    btn.classList.add('active');
                    
                    // Hide all tab content
                    reviewsTab.style.display = 'none';
                    relatedTab.style.display = 'none';
                    
                    // Show the selected tab content
                    const tabName = btn.dataset.tab;
                    if (tabName === 'reviews') {
                        reviewsTab.style.display = 'block';
                    } else if (tabName === 'related') {
                        relatedTab.style.display = 'block';
                    }
                });
            });
            
            /// Create Listing Modal
            document.getElementById('createBtn')?.addEventListener('click', () => {
                console.log("Create button clicked");
                document.getElementById('createListingModal').classList.add('show');
            });

            document.getElementById('createListingBtn')?.addEventListener('click', () => {
                console.log("Create listing button clicked");
                document.getElementById('createListingModal').classList.add('show');
            });
            
            // Close Create Listing Modal
            closeCreateModal.addEventListener('click', () => {
                createListingModal.classList.remove('show');
            });
            
            cancelCreateBtn.addEventListener('click', () => {
                createListingModal.classList.remove('show');
            });
            
            // Close modals when clicking outside
            createListingModal.addEventListener('click', (e) => {
                if (e.target === createListingModal) {
                    createListingModal.classList.remove('show');
                }
            });
            
            productDetailModal.addEventListener('click', (e) => {
                if (e.target === productDetailModal) {
                    productDetailModal.classList.remove('show');
                }
            });
            
            // Close Detail Modal
            closeDetailModal.addEventListener('click', () => {
                productDetailModal.classList.remove('show');
            });
            
            // ESC key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    createListingModal.classList.remove('show');
                    productDetailModal.classList.remove('show');
                }
            });
            
            // Price slider functionality
            priceSlider.addEventListener('input', () => {
                priceDisplay.textContent = priceSlider.value;
            });
            
            // Tag input functionality
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    const tag = tagInput.value.trim();
                    if (tag && document.querySelectorAll('.tag-item').length < 5) {
                        addTag(tag);
                        tagInput.value = '';
                    }
                }
            });
            
            // Add tag function
            const addTag = (tag) => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag-item';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="tag-remove">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                
                // Add remove event listener
                tagElement.querySelector('.tag-remove').addEventListener('click', () => {
                    tagElement.remove();
                });
                
                tagsContainer.appendChild(tagElement);
            };
            
            // File upload functionality
            fileUploadContainer.addEventListener('click', () => {
                fileUpload.click();
            });
            
            fileUploadContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            });
            
            fileUploadContainer.addEventListener('dragleave', () => {
                fileUploadContainer.style.backgroundColor = '';
            });
            
            fileUploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadContainer.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    fileUpload.files = e.dataTransfer.files;
                    updateFileUploadText(fileUpload.files[0].name);
                }
            });
            
            fileUpload.addEventListener('change', () => {
                if (fileUpload.files.length) {
                    updateFileUploadText(fileUpload.files[0].name);
                }
            });
            
            // Update file upload text
            const updateFileUploadText = (filename) => {
                const uploadText = fileUploadContainer.querySelector('.upload-text');
                uploadText.textContent = filename;
                fileUploadContainer.querySelector('.upload-icon').innerHTML = '<i class="fas fa-check"></i>';
                fileUploadContainer.querySelector('.upload-icon').style.color = 'var(--ink-green)';
            };
            
            // Image upload functionality
           // Image upload functionality - with null checks
            if (imageUploadContainer && imageUpload) {
                imageUploadContainer.addEventListener('click', () => {
                    imageUpload.click();
                });
                
                imageUploadContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    imageUploadContainer.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                });
                
                imageUploadContainer.addEventListener('dragleave', () => {
                    imageUploadContainer.style.backgroundColor = '';
                });
                
                imageUploadContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    imageUploadContainer.style.backgroundColor = '';
                    
                    if (e.dataTransfer.files.length) {
                        const file = e.dataTransfer.files[0];
                        if (file.type.match('image.*')) {
                            imageUpload.files = e.dataTransfer.files;
                            showImagePreview(file);
                        }
                    }
                });
                
                imageUpload.addEventListener('change', () => {
                    if (imageUpload.files.length) {
                        showImagePreview(imageUpload.files[0]);
                    }
                });
            }
                        
            // Preview uploaded image
            // Preview uploaded image
            const showImagePreview = (file) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    if (imagePreviewElem) {
                        imagePreviewElem.src = e.target.result;
                        if (imagePreviewContainer) {
                            imagePreviewContainer.style.display = 'block';
                        }
                        
                        // Update upload container text if it exists
                        if (imageUploadContainer) {
                            const textElement = imageUploadContainer.querySelector('.upload-text');
                            if (textElement) textElement.textContent = file.name;
                            
                            const iconElement = imageUploadContainer.querySelector('.upload-icon');
                            if (iconElement) {
                                iconElement.innerHTML = '<i class="fas fa-check"></i>';
                                iconElement.style.color = 'var(--ink-green)';
                            }
                        }
                    }
                };
                
                reader.readAsDataURL(file);
            };
            
            // Submit listing form
            createListingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // Gather form data
                const formData = new FormData();
                formData.append('title', listingTitle.value);
                formData.append('description', listingDescription.value);
                formData.append('subject', listingSubject.value);
                formData.append('category', listingCategory.value);
                formData.append('type', listingType.value);
                formData.append('price', priceSlider.value);
                
                // Add tags
                const tags = [];
                document.querySelectorAll('.tag-item').forEach((tag, index) => {
                    const tagText = tag.textContent.trim();
                    tags.push(tagText);
                    formData.append(`tags[${index}]`, tagText);
                });
                
                // Add file if selected
                if (fileUpload.files.length) {
                    formData.append('file', fileUpload.files[0]);
                }
                
                // Add image if selected
                if (imageUpload.files.length) {
                    formData.append('image', imageUpload.files[0]);
                }
                
                // Send the data to the server
                fetch('/api/marketplace_listings', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showFeedback('Listing created successfully!', 'success');
                        
                        // Close modal
                        createListingModal.classList.remove('show');
                        
                        // Reset form
                        createListingForm.reset();
                        imagePreviewContainer.style.display = 'none';
                        tagsContainer.innerHTML = '';
                        fileUploadContainer.querySelector('.upload-text').textContent = 'Drag & drop your file here';
                        fileUploadContainer.querySelector('.upload-icon').innerHTML = '<i class="fas fa-cloud-upload-alt"></i>';
                        fileUploadContainer.querySelector('.upload-icon').style.color = '';
                        imageUploadContainer.querySelector('.upload-text').textContent = 'Add a thumbnail image';
                        imageUploadContainer.querySelector('.upload-icon').innerHTML = '<i class="fas fa-image"></i>';
                        imageUploadContainer.querySelector('.upload-icon').style.color = '';
                        
                        // Reload listings
                        loadListings();
                    } else {
                        // Show error message
                        showFeedback(data.message || 'Error creating listing', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFeedback('An error occurred. Please try again.', 'error');
                });
            });
            
            // Show feedback message
            const showFeedback = (message, type) => {
                feedbackMessage.textContent = message;
                feedbackMessage.className = `feedback-message ${type}`;
                
                // Show message
                setTimeout(() => {
                    feedbackMessage.classList.add('show');
                }, 100);
                
                // Hide message after 3 seconds
                setTimeout(() => {
                    feedbackMessage.classList.remove('show');
                }, 3000);
            };
            
            // Open product detail modal
            const openProductDetail = (listingId) => {
                // Reset tabs
                tabBtns.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.tab-btn[data-tab="reviews"]').classList.add('active');
                reviewsTab.style.display = 'block';
                relatedTab.style.display = 'none';
                
                // Show loading state
                productDescription.textContent = 'Loading description...';
                reviewsContainer.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-pixels">
                            <div class="loading-pixel"></div>
                            <div class="loading-pixel"></div>
                            <div class="loading-pixel"></div>
                        </div>
                    </div>
                `;
                relatedItems.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-pixels">
                            <div class="loading-pixel"></div>
                            <div class="loading-pixel"></div>
                            <div class="loading-pixel"></div>
                        </div>
                    </div>
                `;
                
                // Show modal
                productDetailModal.classList.add('show');
                
                // Fetch listing details
                fetch(`/api/marketplace_listings/${listingId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const listing = data.listing;
                            
                            // Update detail view
                            productTitle.textContent = listing.title;
                            productCourse.textContent = listing.subject;
                            productQuality.textContent = getQualityLabel(listing.type);
                            productDepartment.innerHTML = `<i class="fas fa-building"></i> ${listing.category}`;
                            productUpdated.innerHTML = `<i class="fas fa-calendar"></i> ${formatDate(listing.created_at)}`;
                            
                            // Set other details
                            const pagesText = listing.type === 'service' ? 'Duration varies' : `${Math.floor(Math.random() * 150) + 50} pages`;
                            productPages.innerHTML = `<i class="fas fa-file-alt"></i> ${pagesText}`;
                            
                            // Set format based on type
                            let formatIcon = 'fa-file-pdf';
                            let formatText = 'PDF';
                            
                            if (listing.type === 'template') {
                                formatIcon = 'fa-file-word';
                                formatText = 'DOCX';
                            } else if (listing.type === 'service') {
                                formatIcon = 'fa-user';
                                formatText = 'Service';
                            } else if (listing.type === 'practice tests') {
                                formatIcon = 'fa-file-alt';
                                formatText = 'PDF + DOCX';
                            }
                            
                            productFormat.innerHTML = `<i class="fas ${formatIcon}"></i> ${formatText}`;
                            
                            // Set description
                            productDescription.textContent = listing.description;
                            
                            // Update preview card
                            previewType.textContent = getCategoryLabel(listing.type);
                            previewQuality.textContent = getQualityShort(listing.type);
                            previewDepartment.textContent = getCategoryShort(listing.category);
                            previewTitle.textContent = listing.title;
                            previewCourse.textContent = listing.subject;
                            
                            // Set preview image
                            // Set preview image
                            if (previewImageElem) {
                                if (listing.preview_path) {
                                    previewImageElem.src = listing.preview_path;
                                } else {
                                    // Use placeholder based on type
                                    previewImageElem.src = `/static/marketplace/placeholders/${listing.type.replace(' ', '_')}_1.jpg`;
                                }
                                // Add error handler
                                previewImageElem.onerror = function() {
                                    this.src = '/static/marketplace/placeholders/generic.png';
                                };
                            }
                            
                            // Set price
                            productPrice.textContent = listing.price;
                            
                            // Set seller info
                            const seller = listing.seller;
                            sellerAvatar.textContent = getInitials(seller.username);
                            sellerName.textContent = seller.username;
                            
                            // Get random rating (in a real app, this would come from the database)
                            const rating = (3.5 + Math.random() * 1.5).toFixed(1);
                            sellerRating.textContent = rating;
                            
                            // Set random review count
                            const reviews = Math.floor(Math.random() * 30) + 5;
                            reviewCount.textContent = reviews;
                            
                            // Set statistics
                            downloadCount.textContent = listing.downloads || Math.floor(Math.random() * 100) + 10;
                            viewCount.textContent = Math.floor(Math.random() * 300) + 50;
                            wishlistCount.textContent = Math.floor(Math.random() * 20);
                            
                            // Set popularity text
                            const departmentCount = Math.floor(Math.random() * 25) + 5;
                            popularityText.textContent = `${departmentCount} students from your department purchased this item`;
                            
                            // Load reviews
                            loadReviews(listingId);
                            
                            // Load related items
                            loadRelatedItems(listing.category, listing._id);
                            
                            // Purchase button logic
                            purchaseBtn.onclick = () => purchaseListing(listing._id, listing.price);
                            
                            // Preview button logic
                            previewBtn.onclick = () => previewListing(listing._id);
                            
                            // Favorite button logic
                            favoriteBtn.onclick = () => toggleFavorite(listing._id);
                        } else {
                            showFeedback('Error loading listing details', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showFeedback('An error occurred. Please try again.', 'error');
                    });
            };
            
            // Helper functions
            
            // Format date
            const formatDate = (dateString) => {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            };
            
            // Get quality label based on type
            const getQualityLabel = (type) => {
                switch (type) {
                    case 'notes':
                        return 'Comprehensive';
                    case 'template':
                        return 'Professional';
                    case 'study guide':
                        return 'In-depth';
                    case 'practice tests':
                        return 'Challenging';
                    case 'service':
                        return 'Expert';
                    case 'research paper':
                        return 'Academic';
                    default:
                        return 'High Quality';
                }
            };
            
            // Get short quality label
            const getQualityShort = (type) => {
                switch (type) {
                    case 'notes':
                        return 'A+';
                    case 'template':
                        return 'PRO';
                    case 'study guide':
                        return 'TOP';
                    case 'practice tests':
                        return '5★';
                    case 'service':
                        return 'EXP';
                    case 'research paper':
                        return 'A+';
                    default:
                        return 'HQ';
                }
            };
            
            // Get category label
            const getCategoryLabel = (type) => {
                return type.charAt(0).toUpperCase() + type.slice(1);
            };
            
            // Get short category label
            const getCategoryShort = (category) => {
                switch (category) {
                    case 'Computer Science':
                        return 'CS';
                    case 'Business':
                        return 'BUS';
                    case 'Data Science':
                        return 'DS';
                    case 'Law':
                        return 'LAW';
                    case 'Engineering':
                        return 'ENG';
                    case 'Arts':
                        return 'ART';
                    case 'Science':
                        return 'SCI';
                    case 'Medicine':
                        return 'MED';
                    case 'Economics':
                        return 'ECO';
                    case 'Mathematics':
                        return 'MAT';
                    default:
                        return category.slice(0, 3).toUpperCase();
                }
            };
            
            // Get default image based on type
            const getDefaultImage = (type) => {
                switch (type) {
                    case 'notes':
                        return '/static/marketplace/placeholder/notes1.gif';
                    case 'template':
                        return '/static/marketplace/placeholder/template1.jpg';
                    case 'study guide':
                        return '/static/marketplace/placeholder/guide2.jpg';
                    case 'practice tests':
                        return '/static/marketplace/placeholder/test1.jpg';
                    case 'service':
                        return '/static/marketplace/placeholder/service1.jpg';
                    case 'research paper':
                        return '/static/marketplace/placeholders/generic.png';
                    default:
                        return '/static/marketplace/placeholders/generic.png';
                }
            };
            
            // Get initials from name
            const getInitials = (name) => {
                return name.split(' ').map(part => part.charAt(0).toUpperCase()).join('');
            };
            
            // Load reviews for a listing
            const loadReviews = (listingId) => {
                // In a real app, you would fetch reviews from the server
                // For now, we'll generate sample reviews
                
                const sampleReviews = [
                    {
                        username: 'Sarah P.',
                        rating: 5,
                        date: '2 weeks ago',
                        content: 'This was exactly what I needed for my course! The content is well-organized and covers all the topics from the semester. Highly recommend!'
                    },
                    {
                        username: 'Michael T.',
                        rating: 4,
                        date: '1 month ago',
                        content: 'Good quality material. It helped me understand the concepts better and prepare for the exams. A few more examples would have been nice though.'
                    },
                    {
                        username: 'Jessica K.',
                        rating: 5,
                        date: '2 months ago',
                        content: 'Worth every coin! The explanations are clear and concise. I particularly appreciated the practice problems and solutions included.'
                    }
                ];
                
                let reviewsHTML = '';
                sampleReviews.forEach(review => {
                    const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                    
                    reviewsHTML += `
                        <div class="review-card">
                            <div class="review-header">
                                <div class="reviewer-info">
                                    <div class="reviewer-avatar">${getInitials(review.username)}</div>
                                    <div class="reviewer-name">${review.username}</div>
                                </div>
                                <div class="review-rating">
                                    ${stars}
                                </div>
                            </div>
                            <div class="review-date">${review.date}</div>
                            <div class="review-content">
                                ${review.content}
                            </div>
                        </div>
                    `;
                });
                
                reviewsContainer.innerHTML = reviewsHTML;
            };
            
            // Load related items
            const loadRelatedItems = (category, currentId) => {
                // In a real app, you would fetch related items from the server
                // For now, we'll use the same endpoint but filter client-side
                
                fetch('/api/marketplace_listings')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Filter listings by category and exclude current listing
                            const relatedListings = data.listings
                                .filter(listing => listing.category === category && listing._id !== currentId)
                                .slice(0, 4); // Limit to 4 items
                            
                            if (relatedListings.length === 0) {
                                relatedItems.innerHTML = '<p>No related items found.</p>';
                                return;
                            }
                            
                            let relatedHTML = '';
                            relatedListings.forEach(listing => {
                                const previewImage = listing.preview_path || getDefaultImage(listing.type);
                                
                                relatedHTML += `
                                    <div class="related-card" data-id="${listing._id}">
                                        <div class="related-preview">
                                            <img src="${previewImage}" alt="${listing.title}">
                                        </div>
                                        <div class="related-details">
                                            <div class="related-title">${listing.title}</div>
                                            <div class="related-price">
                                                <div class="pixel-coin"></div>
                                                ${listing.price}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            relatedItems.innerHTML = relatedHTML;
                            
                            // Add click event listeners
                            document.querySelectorAll('.related-card').forEach(card => {
                                card.addEventListener('click', () => {
                                    const listingId = card.dataset.id;
                                    openProductDetail(listingId);
                                });
                            });
                        } else {
                            relatedItems.innerHTML = '<p>Failed to load related items.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        relatedItems.innerHTML = '<p>Error loading related items.</p>';
                    });
            };
            
            // Purchase a listing
            const purchaseListing = (listingId, price) => {
                // Show confirmation dialog
                if (!confirm(`Are you sure you want to purchase this item for ${price} coins?`)) {
                    return;
                }
                
                // Send purchase request to the server
                fetch('/api/marketplace_transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        listing_id: listingId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showFeedback('Purchase successful! Check your downloads section.', 'success');
                        // Close modal after successful purchase
                        setTimeout(() => {
                            productDetailModal.classList.remove('show');
                        }, 2000);
                    } else {
                        showFeedback(data.message || 'Error making purchase', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showFeedback('An error occurred. Please try again.', 'error');
                });
            };
            
            // Preview a listing
            const previewListing = (listingId) => {
                // In a real app, this would open a preview of the content
                showFeedback('Preview not available in demo mode', 'warning');
            };
            
            // Toggle favorite status
            const toggleFavorite = (listingId) => {
                const heart = favoriteBtn.querySelector('i');
                const isFavorited = heart.classList.contains('fas');
                
                if (isFavorited) {
                    heart.classList.remove('fas');
                    heart.classList.add('far');
                    showFeedback('Removed from favorites', 'success');
                } else {
                    heart.classList.remove('far');
                    heart.classList.add('fas');
                    showFeedback('Added to favorites', 'success');
                }
                
                // In a real app, you would update the server
                // fetch('/api/favorites', {...})
            };
            
            // Load listings
// Load listings
            const loadListings = (page = 1) => {
                // Show loading state
                if (listingsGrid) {
                    listingsGrid.innerHTML = `
                        <div class="loading-container">
                            <div class="loading-pixels">
                                <div class="loading-pixel"></div>
                                <div class="loading-pixel"></div>
                                <div class="loading-pixel"></div>
                            </div>
                        </div>
                    `;
                }
                
                console.log("Loading listings page:", page);
                
                // Get filter values
                const searchTerm = searchInput ? searchInput.value.trim() : '';
                const sortOption = sortSelect ? sortSelect.value : 'newest';
                const typeFilter = typeSelect ? typeSelect.value : 'all';
                
                // Get selected category
                let categoryFilter = 'all';
                categoryItems.forEach(item => {
                    if (item.classList.contains('active')) {
                        categoryFilter = item.dataset.category;
                    }
                });
                
                // Build query parameters
                const params = new URLSearchParams();
                params.append('page', page);
                params.append('limit', 12); // Items per page
                params.append('sort', sortOption);
                
                if (searchTerm) {
                    params.append('search', searchTerm);
                }
                
                if (typeFilter !== 'all') {
                    params.append('type', typeFilter);
                }
                
                if (categoryFilter !== 'all') {
                    params.append('category', categoryFilter);
                }
                
                // Debug logging
                console.log("Fetching with params:", params.toString());
                
                // Fetch listings from server
                fetch(`/api/marketplace_listings?${params.toString()}`)
                    .then(response => {
                        console.log("Response status:", response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Received data:", data);
                        
                        if (data.success) {
                            displayListings(data.listings);
                            if (pagination) {
                                setupPagination(data.total, data.page, data.pages);
                            }
                        } else {
                            if (listingsGrid) {
                                listingsGrid.innerHTML = `<p>Failed to load listings: ${data.message}</p>`;
                            }
                            console.error("API error:", data.message);
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching listings:", error);
                        if (listingsGrid) {
                            listingsGrid.innerHTML = `<p>Error loading listings: ${error.message}</p>`;
                        }
                    });
            };
            
            // Display listings in the grid
            // Display listings in the grid
 // Display listings in the grid
            const displayListings = (listings) => {
                if (!listingsGrid) {
                    console.error("Listings grid element not found!");
                    return;
                }
                
                if (listings.length === 0) {
                    listingsGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; color: var(--ink-gray-dark);"></i>
                            <p>No listings found matching your criteria.</p>
                            <p style="margin-top: 0.5rem;">Try adjusting your filters or create a new listing!</p>
                        </div>
                    `;
                    return;
                }
                
                let listingsHTML = '';
                
                listings.forEach(listing => {
                    // Default placeholder if no preview path
                    const previewPath = listing.preview_path || '/static/marketplace/placeholders/generic.png';
                    
                    // Create simpler listing card HTML
                    listingsHTML += `
                        <div class="listing-card" data-id="${listing._id}">
                            <div class="listing-preview">
                                <div class="listing-type">${listing.type.charAt(0).toUpperCase() + listing.type.slice(1)}</div>
                                <img src="${previewPath}" alt="${listing.title}" 
                                    onerror="this.src='/static/marketplace/placeholders/generic.png'; this.onerror=null;">
                            </div>
                            <div class="listing-details">
                                <div class="listing-course">${listing.subject || ''}</div>
                                <h3 class="listing-title">${listing.title || 'Untitled'}</h3>
                                <div class="listing-description">${listing.description || 'No description'}</div>
                            </div>
                            <div class="listing-footer">
                                <div class="listing-price">
                                    <div class="pixel-coin"></div>
                                    ${listing.price || 0}
                                </div>
                                <div class="listing-stats">
                                    <div class="listing-stat">
                                        <i class="fas fa-download"></i>
                                        ${listing.downloads || 0}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Update the grid content
                listingsGrid.innerHTML = listingsHTML;
                
                // Add click event listeners
                document.querySelectorAll('.listing-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const listingId = card.dataset.id;
                        console.log("Card clicked:", listingId);
                        if (typeof openProductDetail === 'function') {
                            openProductDetail(listingId);
                        } else {
                            console.error("openProductDetail function not defined");
                        }
                    });
                });
            };
            
            // Set up pagination
            const setupPagination = (total, currentPage, totalPages) => {
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }
                
                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                            ${currentPage === 1 ? 'disabled' : `data-page="${currentPage - 1}"`}>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                `;
                
                // Page numbers
                const maxButtons = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
                let endPage = Math.min(totalPages, startPage + maxButtons - 1);
                
                if (endPage - startPage + 1 < maxButtons && startPage > 1) {
                    startPage = Math.max(1, endPage - maxButtons + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">
                            ${i}
                        </button>
                    `;
                }
                
                // Next button
                paginationHTML += `
                    <button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                            ${currentPage === totalPages ? 'disabled' : `data-page="${currentPage + 1}"`}>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                `;
                
                pagination.innerHTML = paginationHTML;
                
                // Add click events to pagination buttons
                document.querySelectorAll('.page-btn:not(.disabled):not(.active)').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const page = parseInt(btn.dataset.page);
                        loadListings(page);
                        
                        // Scroll to top of listings
                        window.scrollTo({
                            top: document.querySelector('.filter-bar').offsetTop - 80,
                            behavior: 'smooth'
                        });
                    });
                });
            };
            
            // Initialize the page
            loadListings();
        });
    </script>
</body>
</html>